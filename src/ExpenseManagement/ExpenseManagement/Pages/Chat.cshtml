@page
@model ExpenseManagement.Pages.ChatModel
@{
    ViewData["Title"] = "Chat";
}

<style>
    .chat-container {
        height: calc(100vh - 250px);
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8fafc;
        border-radius: 12px;
        margin-bottom: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        word-wrap: break-word;
    }
    
    .message.assistant .message-bubble {
        background-color: white;
        border: 1px solid #e2e8f0;
    }
    
    .message.user .message-bubble {
        background-color: #6366f1;
        color: white;
    }
    
    .message-bubble ol, .message-bubble ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    .chat-input {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input input {
        flex: 1;
    }
    
    .typing-indicator {
        display: none;
        padding: 0.5rem;
        color: #64748b;
        font-style: italic;
    }
    
    .typing-indicator.active {
        display: block;
    }
</style>

<div class="card">
    <div class="card-body chat-container">
        <h4 class="card-title mb-3">AI Assistant</h4>
        
        @if (!Model.IsEnabled)
        {
            <div class="alert alert-info">
                <strong>GenAI services not deployed.</strong>
                To enable the AI chat functionality, please run the <code>deploy-with-chat.sh</code> script instead of <code>deploy.sh</code>.
                This will deploy the Azure OpenAI and AI Search resources needed for the chat feature.
                Until then, you can still use all the expense management features through the UI.
            </div>
        }
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-bubble">
                    Hello! I'm your Expense Management assistant. I can help you with:
                    <ul>
                        <li>Viewing and searching expenses</li>
                        <li>Creating new expenses</li>
                        <li>Submitting expenses for approval</li>
                        <li>Approving or rejecting expenses (for managers)</li>
                        <li>Getting expense summaries and statistics</li>
                    </ul>
                    How can I help you today?
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            Assistant is thinking...
        </div>
        
        <div class="chat-input">
            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." @(Model.IsEnabled ? "" : "disabled")>
            <button id="sendButton" class="btn btn-primary" @(Model.IsEnabled ? "" : "disabled")>Send</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        
        let conversationHistory = [];
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatMessage(text) {
            // First escape HTML
            let escaped = escapeHtml(text);
            
            // Apply markdown-style formatting
            // Bold
            escaped = escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Process lines for lists
            const lines = escaped.split('\n');
            let result = [];
            let inOrderedList = false;
            let inUnorderedList = false;
            
            for (let line of lines) {
                // Numbered list
                if (/^\d+\.\s/.test(line.trim())) {
                    if (!inOrderedList) {
                        if (inUnorderedList) {
                            result.push('</ul>');
                            inUnorderedList = false;
                        }
                        result.push('<ol>');
                        inOrderedList = true;
                    }
                    result.push('<li>' + line.trim().replace(/^\d+\.\s/, '') + '</li>');
                }
                // Bullet list
                else if (/^[-*]\s/.test(line.trim())) {
                    if (!inUnorderedList) {
                        if (inOrderedList) {
                            result.push('</ol>');
                            inOrderedList = false;
                        }
                        result.push('<ul>');
                        inUnorderedList = true;
                    }
                    result.push('<li>' + line.trim().replace(/^[-*]\s/, '') + '</li>');
                }
                else {
                    if (inOrderedList) {
                        result.push('</ol>');
                        inOrderedList = false;
                    }
                    if (inUnorderedList) {
                        result.push('</ul>');
                        inUnorderedList = false;
                    }
                    result.push(line);
                }
            }
            
            if (inOrderedList) result.push('</ol>');
            if (inUnorderedList) result.push('</ul>');
            
            return result.join('<br>').replace(/<br><(ol|ul)>/g, '<$1>').replace(/<\/(ol|ul)><br>/g, '</$1>');
        }
        
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            messageInput.value = '';
            addMessage('user', message);
            
            conversationHistory.push({ role: 'user', content: message });
            
            typingIndicator.classList.add('active');
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(0, -1)
                    })
                });
                
                const data = await response.json();
                
                addMessage('assistant', data.message);
                conversationHistory.push({ role: 'assistant', content: data.message });
            } catch (error) {
                addMessage('assistant', 'Sorry, an error occurred. Please try again.');
                console.error('Chat error:', error);
            } finally {
                typingIndicator.classList.remove('active');
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }
        
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
}
